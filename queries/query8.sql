select s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
     (SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '99148','14140','53002','21895','12160','92371',
                          '14892','49798','15459','12274','70495',
                          '52014','97715','17739','10237','59188',
                          '83998','90166','25772','97130','18686',
                          '16144','66528','10939','89359','50546',
                          '30150','90878','92542','35479','26668',
                          '50744','33483','73506','61965','84608',
                          '82155','13303','30076','13262','90592',
                          '99213','11604','37243','58571','14265',
                          '36297','64689','23523','85050','50849',
                          '17720','41566','58749','44070','15193',
                          '68080','13213','14633','11509','28628',
                          '40857','79615','99340','43278','85381',
                          '97906','30365','24846','15285','64156',
                          '16183','15420','61890','89167','87448',
                          '86652','72778','96451','51110','26267',
                          '69191','63159','69961','27098','40363',
                          '55755','37145','23057','80486','45076',
                          '73748','37483','55719','90083','11111',
                          '70719','71893','44138','68042','45137',
                          '23295','70904','66296','26446','20180',
                          '89283','21145','44909','75323','63215',
                          '21939','15023','42900','83907','47194',
                          '11242','84786','32397','64373','92503',
                          '23474','15737','50855','50307','65490',
                          '54288','14702','89635','84185','82133',
                          '72038','60421','67015','52932','89945',
                          '20501','60893','32215','71638','28918',
                          '79762','11218','57914','40119','36050',
                          '17258','73328','74624','67165','20258',
                          '71270','58847','77831','78860','34002',
                          '22724','92108','79474','70003','90826',
                          '87205','31724','44667','17204','88118',
                          '84555','39069','23272','64365','77008',
                          '40836','16061','52024','14535','82792',
                          '62101','70486','39463','28119','61632',
                          '28595','18978','56104','77779','85312',
                          '43500','94720','98734','99903','40381',
                          '28199','15003','49085','94399','69092',
                          '45352','45625','23283','39259','15304',
                          '45920','95140','97697','58585','46836',
                          '68927','88218','39686','11072','66324',
                          '39078','33940','55498','54573','37720',
                          '29019','84218','17756','99756','33661',
                          '45443','17385','29337','83251','53478',
                          '63093','76171','65602','87062','14513',
                          '58621','47249','86013','10326','68022',
                          '94174','60681','92429','64727','51405',
                          '18946','59123','48620','60710','87260',
                          '27761','81166','92700','51784','52410',
                          '18292','55938','46249','55973','34089',
                          '11436','84960','39659','28900','21903',
                          '41621','14730','35981','16052','38228',
                          '89731','12515','66129','59193','25836',
                          '43550','70205','13716','90747','20160',
                          '14761','71464','62258','49338','38468',
                          '41152','59074','27128','19560','84651',
                          '33965','70636','57842','20804','62718',
                          '83798','52370','66972','20575','72245',
                          '37496','84513','46109','27771','23169',
                          '18743','30983','62517','99350','78594',
                          '68692','91125','49710','12011','56381',
                          '15141','72848','57428','35931','70945',
                          '69971','66589','92723','31244','61082',
                          '71368','27655','16342','96700','64711',
                          '11505','25325','77784','84228','18003',
                          '33332','49845','17608','80083','42301',
                          '35907','45148','13535','21491','15566',
                          '20965','34297','17601','21942','12711',
                          '14371','11902','50493','64682','46051',
                          '51199','39617','94734','87962','66753',
                          '19329','35061','34874','15093','36999',
                          '20446','52042','87426','29565','57806',
                          '47719','27661','15507','16218','15595',
                          '16675','39953','74150','15571','84779',
                          '74361','79055','83043','36642','16477',
                          '27961','16752','71407','14629','21834',
                          '10113','74613','17133','32694','37181',
                          '67632','64728','55210','14911','84467',
                          '49413','92304','61489','56839'))
     intersect
     (select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1))A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100

